# The TeXLive.net Server

## Introduction

The TeXLive.net server (formally known as (LaTeX CGI server)
(currently running at [texlive.net](https://texlive.net)) accepts
LaTeX documents via an HTTP POST request and returns a PDF document or
log file in the case of error.

It is written as a perl script accepting the post requests via cgi-bin access in an apache HTTP server.

## Example Documents

* [Basic tests](test).
* [Larger test examples](test2).
* [CJK Font test examples](test3).
* [plain tex and non interactive examples](test4).
* [Experimental context example](testc)
* [Snippet/Document Fragment examples (runlatex-sk)](test-sk.html)
* [Snippet/Document Fragment test cases (runlatex-sk)](test2-sk.html)

### Tutorial site using this server (runlatex.js)
* [The learnlatex.org tutorial site](https://www.learnlatex.org).

### LaTeX Forums using this server (runlatex-sk.js)
* [LaTeX Community Forum](https://latex.org/forum/)
* [TeXWelt German Language TeX Forum](https://texwelt.de/)


## HTTP Requests

The document must be supplied by an HTTP POST multipart/form-data request.
Any other HTTP request is rejected. The allowed form fields are defined below.
If the form contains unexpected fields, the whole submission is rejected.

## Form Fields

 * engine
 
   This field is optional, but if supplied must be one of  
   `lualatex`, `pdflatex`, `xelatex`, `uplatex`, `platex`, `latex`,  
   `lualatex-dev`, `pdflatex-dev`, `xelatex-dev`, `uplatex-dev`, `platex-dev`, `latex-dev`,  
   `luatex`, `pdftex`, `xetex`, `uptex`, `ptex`, `tex`,  
   `context`.
   
   The default is `pdflatex`.
 * bibcmd
 
   This field is optional, but if supplied must be one of  
   `biber`, `bibtex`, `pbibtex`, `bibtex8`.
   
   It defaults to empty unless the log of the first run from LaTeX has
   a biblatex message saying
   to run biber or bibtex, or if there is a `No file document.bbl` message.
 * filename[]
 
   There must be at least one of these parameters, each specifying a filename.
   There must be one `filename[]` parameter with value `document.tex`
 * filecontents[]
 
   These multi-line fields contain the contents of the supplied files.
   There must be the same number of `filecontents[]` parameters as `filename[]` parameters.

 * return

   This field is optional but if supplied must be one or `pdfjs`, `pdf` or `log`.

   The default is `pdfjs` meaning the PDF.js is used to render the PDF.

   `pdf` specifies that the PDF document should be returned, so will use your browser's default PDF renderer.

   `log` specifies that the log file should be returned even in non-error cases.
   
 * makeindex[]
 
   This field is optional and may be used multiple times.

   The value must be of the form `makindex` _options_

   `options` gives the options for `makeindex` for the document
   `document.tex`
   it is currently restricted to `-` and `.` and ASCII letters and digits.




## The learnlatex Comment Interface (runlatex.js)
Usually the form for the HTTP submission is generated by the  `runlatex`  JavaScript,
[maintained at the learnlatex Github](https://github.com/learnlatex/learnlatex.github.io/blob/main/assets/scripts/runlatex.js). 

This constructs the parameters from one or more HTML `<pre>` elements, which may be controlled using comments of the form
```
% !TEX  ... keyword
```

The comments are checked in a case insensitive way, any text other than the final keyword is ignored, so the following are all equivalent
```
% !TEX lualatex
%  !TeX  program = LuaLaTeX
% !tex  ignored comment lualatex
```

The known keywords are

* `lualatex`, `pdflatex`, `xelatex`, `uplatex`, `platex`, `latex`,
  `lualatex-dev`, `pdflatex-dev`, `xelatex-dev`, `uplatex-dev`,
  `platex-dev`, `latex-dev`, `luatex`, `pdftex`, `xetex`,
  `uptex`, `ptex`, `tex`, `context`.

   The `engine` parameter is set to the specified keyword (lowercased).
 
   If this is not used then `engine` is set to `pdflatex`.
 
* `biber`, `bibtex`, `pbibtex`, `bibtex8`
 
   The `bibcmd` parameter is set to the specified keyword (lowercased).
  
   If this is not used the `bibcmd` parameter is not set and bibtex or biber may be chosen automatically as described above.

* `pdfjs`, `pdf`, `log`

   The `return` parameter is set to the specfied keyword (lowercased).

   If this is not used, the `return` parameter is not set and the server will use PDF.js as described above.
  
*  `makeindex` _options_
 
   There may be any number of `% !TEX makeindex` comments, the options
   are passed to the LaTeX CGI server `makeindex[]` parameters
   described above.

   See <a href="test#makeindex">the makeindex example in the test document</a>.
 
 
### No Edit Option

If an HTML `<pre>` element or its parent `<div>` has the CSS `noedit`
class then it is not processed by this JavaScript and the original
`<pre>` is displayed. (In GitHub pages  the markup `{: .noedit :}`
may be placed after the code block to add this class.) 

### No TeX compilation

If the code block does not contain either `\documentclass` or a `%
!TEX` comment that specifies a TeX engine, no buttons are added to
submit the document to an online TeX system.

### Multifile Projects.

Normally just the file corresponding to a single code block is
submitted but the page may contain a javascript `preincludes` array
that specifies a mapping of code blocks to filenames to control a
multi-file submission to either texlive.net or Overleaf.

See [LearnLaTeX lesson 13](https://www.learnlatex.org/en/lesson-13).

## The TeXWelt Comment Interface (runlatex-sk.js)
A modified version of the  `runlatex`  JavaScript,
[maintained at this site](https://github.com/davidcarlisle/latexcgi/blob/main/docs/runlatex-sk.js)

Compared to `runlatex.js`, `runlatex-sk.js` makes some adaptations so
that it is more suitable for a forum context where there is no access
to underlying markdown for each page, and where the code blocks are
entered by end users in questions and answers and so can not be
pre-validated in the style of a curated set of tutorial examples.

* Code relating to other servers (eg Overleaf) and to multi-file
  submission is removed.

* If the `% !TEX ...` comment is not used to specify the engine, then
  the engine parameter is defaulted depending on the content of the
  example, currently use of `fontspec` defaulting to `xelatex` and
  use of `pstricks` causing the  engine to default to
  `latex`/`dvips/``ps2pdf`.
  
* If neither `\documentclass` nor a `% !TeX` engine cooment appears in
  the example then a default preamble is constructed (based on the
  commands seen in the example) and added to the code block via the
  ACE editor interface.  This preamble may not be completely correct
  as needed to run the example but is a good "first guess" and will
  save typing boiler plate preambles in the online forum editor. If
  the preamble is edited and re-submitted to the texlive.net server,
  the boiler plate preamble is not re-added.

### Code blocks without TeX submission

* Two special `!TEX` comments may be used, which must be on the first
  line. The comment marker for these does not need to be `%` it can be
  any combination of `%`, `#`, `/`, `*`.

    - `!TEX noedit` causes the div to be left unchanged
    - `!TEX none` causes the editor to be used in Text mode, and no
      texlive.net button is added.
	  
  If the the first non-white line does not start with `%` and does not
  contain a `\ ` then the no-compile, `none` mode is assumed, so that
  log files, shell scripts etc may be inserted without being
  interpreted as LaTeX.
  
### Captions

* Optionally a caption may be added above the editor in the cases that
  a compile button is added below.


## Processing Pipeline

1. Assuming the form fields are all validated, the supplied files are unpacked into a new temporary directory.
2. LaTeX is run on `document.tex` (using whichever engine is specified by engine parameter).
3. If there was an error, the log is returned and processing stops.
4. The log is searched for requests to run biber or bibtex, or to rerun latex.
5. If no "rerun" messages were found, the PDF is returned and processing stops.
6. If bibtex or biber is detected the relevant command as explicitly or implicitly specified in the bibcmd parameter is run.
7. If an error occurs in bibtex/biber, a log is returned (Currently this just has the exit status).
8. If any `makeindex[]` calls are specified these are run, if the previous command gave no error.
9. LaTeX is run twice more, checking for error after each run.
10. For pLaTeX variants `dvipdfmx` is called to generate PDF. For latex, `dvips` and `ps2pdf` are called to generate PDF.
11. The PDF or error log is moved, and the temporary directory is deleted.
12. A PDF is returned, or the log file in case of error (or log requested).


Each system call is guarded by a timeout so "Error" in the above
stages may be that the command was taking too long rather than an
actual error. There are also restrictions on input paths for security
reasons, attempting to input files out of the allowed area will result
in `input error` being returned as the log, neither the TeX log nor the
generated PDF will be returned.

The PDF document is not directly returned, the site hosts an instance
of [PDF.js](https://mozilla.github.io/pdf.js) and returns
`PDF.js?file=document-xxxxx.pdf` primarily to ensure rendering in
mobile clients that often do not include a PDF renderer by default.

